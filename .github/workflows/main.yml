name: Build and Deploy React App

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm install --force

      - name: ‚öôÔ∏è Build React App (using env.dev)
        run: |
          echo "üõ†Ô∏è Building with DEV environment..."
          npx env-cmd -f .env.dev npm run build

      - name: üöÄ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Write SSH key to a file
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          # Test SSH connection first
          echo "üîå Testing SSH connection to EC2..."
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo '‚úÖ SSH connection successful!'"

          # Exit if SSH test failed
          if [ $? -ne 0 ]; then
            echo "‚ùå SSH connection failed. Exiting."
            exit 1
          fi

          # Run deployment commands in a single SSH session
          echo "üöÄ Deploying React app to EC2..."
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            set -e  # Exit immediately if any command fails

            echo "üßπ Cleaning previous build folder..."
            rm -rf /tmp/dist

            echo "üì§ Copying new build from GitHub Actions..."

          # Copy build folder to EC2
          scp -i ec2_key.pem -o StrictHostKeyChecking=no -r dist $EC2_USER@$EC2_HOST:/tmp/dist

          # Continue deployment on EC2
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            echo "üßπ Removing old files from Nginx HTML root..."
            sudo rm -rf /usr/share/nginx/html/theater-app

            echo "üìÅ Creating fresh directory..."
            sudo mkdir -p /usr/share/nginx/html/theater-app

            echo "üì¶ Moving new build files..."
            sudo cp -r /tmp/dist/* /usr/share/nginx/html/theater-app/

            echo "üßº Cleaning up temp build folder..."
            rm -rf /tmp/dist

            echo "üîÅ Restarting Nginx..."
            sudo systemctl restart nginx

            echo "‚úÖ Deployment complete!"

