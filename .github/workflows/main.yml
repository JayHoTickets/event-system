name: Build and Deploy React App

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: npm install --force

      - name: âš™ï¸ Build React App (using env.dev)
        run: |
          echo "ðŸ› ï¸ Building with DEV environment..."
          npx env-cmd -f .env.dev npm run build

      - name: ðŸš€ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem
          
          echo "ðŸ§¹ Cleaning previous build folder on EC2..."
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "rm -rf /tmp/dist"

          echo "ðŸ“¤ Copying new build folder to EC2..."
          scp -r -i ec2_key.pem -o StrictHostKeyChecking=no dist $EC2_USER@$EC2_HOST:/tmp/

          echo "ðŸš€ Deploying on EC2 server..."
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            echo "ðŸ§¹ Removing ALL previous files from Nginx HTML root..."
            sudo rm -rf /usr/share/nginx/html/theater-app

            echo "ðŸ“ Creating fresh react-app directory..."
            sudo mkdir -p /usr/share/nginx/html/theater-app

            echo "ðŸ“¦ Copying new build files to react-app directory..."
            sudo cp -r /tmp/dist/* /usr/share/nginx/html/theater-app/

            echo "ðŸ§¼ Cleaning up temp files..."
            rm -rf /tmp/dist

            echo "ðŸ” Restarting Nginx..."
            sudo systemctl restart nginx
          EOF
